{% extends 'layout.html' %}

{% block head %}
<title>Gestione Territori - Selezione Comune</title>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8 mx-auto">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <div class="d-flex justify-content-between align-items-center">
                    <h4 class="mb-0">
                        <i class="fas fa-map-marker-alt me-2"></i>
                        Assegnazione Territori agli Agenti
                    </h4>
                    <a href="{{ url_for('mappa_completa') }}" class="btn btn-light btn-sm">
                        <i class="fas fa-map-marked-alt me-1"></i> Mappa Completa
                    </a>
                </div>
            </div>
            <div class="card-body">
                <form id="selectionForm" action="{{ url_for('submit') }}" method="post">
                    <!-- Selezione o Creazione Agente -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <label for="agentSelect" class="form-label">Seleziona Agente Esistente</label>
                            <select class="form-select" id="agentSelect">
                                <option value="" selected>-- Seleziona un agente --</option>
                                {% for agent in agents %}
                                <option value="{{ agent.id }}" {% if edit_agent and edit_agent.id == agent.id %}selected{% endif %}
                                        data-color="{{ agent.color }}"
                                        data-phone="{{ agent.phone or '' }}"
                                        data-email="{{ agent.email or '' }}">
                                    {{ agent.name }}
                                </option>
                                {% endfor %}
                                <option value="new">+ Crea nuovo agente</option>
                            </select>
                        </div>
                        
                        <div class="col-md-6">
                            <label for="agent_name" class="form-label">Nome Agente</label>
                            <input type="text" class="form-control" id="agent_name" name="agent_name" 
                                   {% if edit_agent %}value="{{ edit_agent.name }}"{% endif %} required>
                            <div class="form-text">Nome dell'agente da creare o modificare</div>
                        </div>
                    </div>
                    
                    <div class="row mb-4">
                        <div class="col-md-4">
                            <label for="agent_color" class="form-label">Colore Agente</label>
                            <input type="color" class="form-control form-control-color" id="agent_color" name="agent_color" 
                                   {% if edit_agent %}value="{{ edit_agent.color }}"{% else %}value="#ff9800"{% endif %}>
                            <div class="form-text">Colore per identificare i territori dell'agente sulla mappa</div>
                        </div>
                        
                        <div class="col-md-4">
                            <label for="agent_phone" class="form-label">Cellulare</label>
                            <input type="tel" class="form-control" id="agent_phone" name="agent_phone" 
                                   {% if edit_agent and edit_agent.phone %}value="{{ edit_agent.phone }}"{% endif %} 
                                   placeholder="Es. +39 333 1234567">
                            <div class="form-text">Numero di cellulare dell'agente (opzionale)</div>
                        </div>
                        
                        <div class="col-md-4">
                            <label for="agent_email" class="form-label">Email</label>
                            <input type="email" class="form-control" id="agent_email" name="agent_email" 
                                   {% if edit_agent and edit_agent.email %}value="{{ edit_agent.email }}"{% endif %} 
                                   placeholder="email@esempio.com">
                            <div class="form-text">Indirizzo email dell'agente (opzionale)</div>
                        </div>
                    </div>

                    <div class="row mb-4">
                        <!-- Regione -->
                        <div class="col-md-4 mb-3 mb-md-0">
                            <label for="region" class="form-label">Regione</label>
                            <select class="form-select" id="region" name="region" required>
                                <option value="" selected>Seleziona una regione</option>
                                {% for region in regions %}
                                <option value="{{ region }}">{{ region }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <!-- Provincia -->
                        <div class="col-md-4 mb-3 mb-md-0">
                            <label for="province" class="form-label">Provincia</label>
                            <select class="form-select" id="province" name="province" disabled>
                                <option value="">Seleziona prima una regione</option>
                            </select>
                        </div>

                        <!-- Comuni -->
                        <div class="col-md-4">
                            <label for="comuni" class="form-label">Comuni</label>
                            <select class="form-select" id="comuni" name="comuni" multiple size="5" disabled>
                                <option value="">Seleziona prima una provincia</option>
                            </select>
                            <div class="form-text">
                                <small class="text-muted">Tieni premuto CTRL per selezionare più comuni</small>
                                <br>
                                <small class="text-warning">Nota: I comuni già assegnati ad altri agenti non possono essere riassegnati</small>
                            </div>
                        </div>
                    </div>

                    <!-- Selected Comuni List -->
                    <div class="mb-4">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <label class="form-label mb-0">Comuni Selezionati</label>
                            <button type="button" id="clearComuniBtn" class="btn btn-sm btn-outline-danger" disabled>
                                <i class="fas fa-trash-alt me-1"></i>
                                Cancella Tutti
                            </button>
                        </div>
                        <div id="selectedComuniContainer" class="border rounded p-3 min-height-100">
                            <p id="noComuniMessage" class="text-muted">Nessun comune selezionato</p>
                            <div id="selectedComuni" class="d-flex flex-wrap gap-2">
                                <!-- Selected comuni will be displayed here -->
                            </div>
                        </div>
                    </div>

                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <button type="button" id="resetBtn" class="btn btn-secondary">
                            <i class="fas fa-undo me-1"></i>
                            Reset
                        </button>
                        <button type="submit" id="submitBtn" class="btn btn-primary" disabled>
                            <i class="fas fa-map me-1"></i>
                            Visualizza Mappa
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const agentSelect = document.getElementById('agentSelect');
    const agentNameInput = document.getElementById('agent_name');
    const agentColorInput = document.getElementById('agent_color');
    const agentPhoneInput = document.getElementById('agent_phone');
    const agentEmailInput = document.getElementById('agent_email');
    const regionSelect = document.getElementById('region');
    const provinceSelect = document.getElementById('province');
    const comuniSelect = document.getElementById('comuni');
    const selectedComuniContainer = document.getElementById('selectedComuni');
    const noComuniMessage = document.getElementById('noComuniMessage');
    const submitBtn = document.getElementById('submitBtn');
    const resetBtn = document.getElementById('resetBtn');
    const selectionForm = document.getElementById('selectionForm');
    
    // Selected comuni storage
    const selectedComuniMap = new Map();
    
    // Handle agent selection
    agentSelect.addEventListener('change', function() {
        const selectedValue = this.value;
        
        if (selectedValue === 'new') {
            // Create new agent
            agentNameInput.value = '';
            agentNameInput.readOnly = false;
            agentColorInput.value = '#ff9800'; // Default color for new agents
            
            // Clear selected comuni
            selectedComuniMap.clear();
            updateSelectedComuniDisplay(); // Aggiorna stato del bottone "Visualizza Mappa"
        } else if (selectedValue) {
            // Selected existing agent
            const selectedOption = this.options[this.selectedIndex];
            agentNameInput.value = selectedOption.textContent.trim();
            agentNameInput.readOnly = true;
            
            // Set the color, phone and email from the data attributes
            const agentColor = selectedOption.getAttribute('data-color');
            const agentPhone = selectedOption.getAttribute('data-phone');
            const agentEmail = selectedOption.getAttribute('data-email');
            
            agentColorInput.value = agentColor || '#ff9800';
            agentPhoneInput.value = agentPhone || '';
            agentEmailInput.value = agentEmail || '';
            
            // Fetch agent's assigned comuni - aggiungiamo un timestamp per evitare la cache
            const agentTimestamp = new Date().getTime();
            fetch('{{ url_for("get_agent_comuni") }}?_=' + agentTimestamp, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'Cache-Control': 'no-cache, no-store, must-revalidate',
                    'Pragma': 'no-cache',
                    'Expires': '0'
                },
                body: 'agent_id=' + encodeURIComponent(selectedValue)
            })
            .then(response => response.json())
            .then(comuni => {
                // Clear current selection
                selectedComuniMap.clear();
                
                // Add agent's comuni to selection
                comuni.forEach(comune => {
                    selectedComuniMap.set(comune.id, {
                        id: comune.id,
                        name: comune.name,
                        province: comune.province,
                        region: comune.region
                    });
                });
                
                // Update display
                updateSelectedComuniDisplay();
            })
            .catch(error => {
                console.error('Error fetching agent comuni:', error);
                showToast('Errore nel caricamento dei comuni dell\'agente', 'danger');
            });
        } else {
            // No agent selected
            agentNameInput.value = '';
            agentNameInput.readOnly = false;
            agentColorInput.value = '#ff9800'; // Reset to default color
            
            // Clear selected comuni
            selectedComuniMap.clear();
            updateSelectedComuniDisplay(); // Aggiorna stato del bottone "Visualizza Mappa"
        }
    });
    
    // Update provinces when region changes
    regionSelect.addEventListener('change', function() {
        provinceSelect.innerHTML = '<option value="">Caricamento...</option>';
        provinceSelect.disabled = true;
        comuniSelect.innerHTML = '<option value="">Seleziona prima una provincia</option>';
        comuniSelect.disabled = true;
        
        if (!this.value) {
            provinceSelect.innerHTML = '<option value="">Seleziona prima una regione</option>';
            return;
        }
        
        // Fetch provinces for selected region - aggiungiamo un timestamp per evitare la cache
        const provinceTimestamp = new Date().getTime();
        fetch('{{ url_for("get_provinces") }}?_=' + provinceTimestamp, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'Cache-Control': 'no-cache, no-store, must-revalidate',
                'Pragma': 'no-cache',
                'Expires': '0'
            },
            body: 'region=' + encodeURIComponent(this.value)
        })
        .then(response => response.json())
        .then(provinces => {
            provinceSelect.innerHTML = '<option value="">Seleziona una provincia</option>';
            provinces.forEach(province => {
                const option = document.createElement('option');
                option.value = province;
                option.textContent = province;
                provinceSelect.appendChild(option);
            });
            provinceSelect.disabled = false;
        })
        .catch(error => {
            console.error('Error fetching provinces:', error);
            provinceSelect.innerHTML = '<option value="">Errore nel caricamento</option>';
        });
    });
    
    // Update comuni when province changes
    provinceSelect.addEventListener('change', function() {
        comuniSelect.innerHTML = '<option value="">Caricamento...</option>';
        comuniSelect.disabled = true;
        
        if (!this.value) {
            comuniSelect.innerHTML = '<option value="">Seleziona prima una provincia</option>';
            return;
        }
        
        // Fetch comuni for selected province - aggiungiamo un timestamp per evitare la cache
        const timestamp = new Date().getTime();
        fetch('{{ url_for("get_comuni") }}?_=' + timestamp, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'Cache-Control': 'no-cache, no-store, must-revalidate',
                'Pragma': 'no-cache',
                'Expires': '0'
            },
            body: 'province=' + encodeURIComponent(this.value)
        })
        .then(response => response.json())
        .then(comuni => {
            comuniSelect.innerHTML = '';
            comuni.forEach(comune => {
                const option = document.createElement('option');
                option.value = comune.codice;
                option.textContent = comune.comune;
                
                // If already assigned to another agent, disable and mark with a warning
                // Aggiungiamo un controllo di freschezza sui dati per evitare che i comuni liberati
                // rimangano marcati come "Già assegnato" dopo l'eliminazione di un agente
                if (comune.assigned && !selectedComuniMap.has(comune.codice)) {
                    option.disabled = true;
                    option.className = 'text-warning';
                    option.textContent += ' (Già assegnato)';
                }
                
                // If this comune is already selected, mark it as selected
                if (selectedComuniMap.has(comune.codice)) {
                    option.selected = true;
                }
                
                comuniSelect.appendChild(option);
            });
            comuniSelect.disabled = false;
        })
        .catch(error => {
            console.error('Error fetching comuni:', error);
            comuniSelect.innerHTML = '<option value="">Errore nel caricamento</option>';
        });
    });
    
    // Handle comune selection
    comuniSelect.addEventListener('change', function() {
        // Clear previously selected comuni from this province
        Array.from(this.options).forEach(option => {
            if (!option.selected && selectedComuniMap.has(option.value)) {
                selectedComuniMap.delete(option.value);
            }
        });
        
        // Add newly selected comuni, ensuring no duplicates
        Array.from(this.selectedOptions).forEach(option => {
            // Check if this comune is already assigned to another agent
            const comuneId = option.value;
            
            // If comune not already in the map, add it
            if (!selectedComuniMap.has(comuneId)) {
                selectedComuniMap.set(comuneId, {
                    id: comuneId,
                    name: option.textContent,
                    province: provinceSelect.value,
                    region: regionSelect.value
                });
            }
        });
        
        // Update the display of selected comuni
        updateSelectedComuniDisplay();
    });
    
    // Clear Comuni button
    const clearComuniBtn = document.getElementById('clearComuniBtn');
    clearComuniBtn.addEventListener('click', function() {
        // Confirm before clearing
        if (confirm('Sei sicuro di voler cancellare tutti i comuni selezionati?')) {
            // Se abbiamo un agente esistente selezionato, dobbiamo inviare la rimozione al server
            const selectedAgentId = agentSelect.value;
            
            if (selectedAgentId && selectedAgentId !== 'new' && selectedComuniMap.size > 0) {
                // Abbiamo un agente selezionato con comuni da rimuovere
                // Inviamo una richiesta per salvare le modifiche (rimozione di tutti i comuni)
                const formData = new FormData();
                formData.append('agent_name', agentNameInput.value);
                formData.append('agent_color', agentColorInput.value);
                formData.append('agent_phone', agentPhoneInput.value);
                formData.append('agent_email', agentEmailInput.value);
                formData.append('agent_id', selectedAgentId); // Aggiungiamo l'ID dell'agente
                // Non includiamo alcun comune, così verranno tutti rimossi
                
                // Aggiungiamo un timestamp per evitare il caching
                const clearTimestamp = new Date().getTime();
                fetch('{{ url_for("submit") }}?_=' + clearTimestamp, {
                    method: 'POST',
                    headers: {
                        'Cache-Control': 'no-cache, no-store, must-revalidate',
                        'Pragma': 'no-cache',
                        'Expires': '0'
                    },
                    body: formData
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Risposta server non valida');
                    }
                    return response.text();
                })
                .then(() => {
                    showToast('Comuni rimossi con successo dal database', 'success');
                    // Svuota la mappa locale e aggiorna l'interfaccia
                    selectedComuniMap.clear();
                    updateSelectedComuniDisplay();
                    
                    // Deselect all options in multi-select
                    if (!comuniSelect.disabled) {
                        Array.from(comuniSelect.options).forEach(option => {
                            option.selected = false;
                        });
                    }
                    
                    // Ricarichiamo la pagina per riflettere i cambiamenti nel database
                    window.location.reload();
                })
                .catch(error => {
                    console.error('Errore durante la cancellazione:', error);
                    showToast('Errore durante la rimozione dal database', 'danger');
                });
            } else {
                // Caso normale: solo UI, senza agente selezionato o senza comuni
                selectedComuniMap.clear();
                updateSelectedComuniDisplay();
                
                // Deselect all options in multi-select
                if (!comuniSelect.disabled) {
                    Array.from(comuniSelect.options).forEach(option => {
                        option.selected = false;
                    });
                }
            }
        }
    });
    
    // Function to update the display of selected comuni
    function updateSelectedComuniDisplay() {
        // Clear current display
        selectedComuniContainer.innerHTML = '';
        
        // Il bottone "Visualizza Mappa" è sempre abilitato se abbiamo un agente selezionato
        const isAgentSelected = agentSelect.value && agentSelect.value !== '';
        submitBtn.disabled = !isAgentSelected;
        
        if (selectedComuniMap.size === 0) {
            noComuniMessage.style.display = 'block';
            clearComuniBtn.disabled = true;
        } else {
            noComuniMessage.style.display = 'none';
            clearComuniBtn.disabled = false;
            
            // Add each selected comune as a badge
            selectedComuniMap.forEach(comune => {
                const badge = document.createElement('div');
                badge.className = 'badge bg-primary d-flex align-items-center p-2 me-2 mb-2';
                badge.innerHTML = `
                    <span>${comune.name} (${comune.province}, ${comune.region})</span>
                    <button type="button" class="btn-close btn-close-white ms-2" 
                            aria-label="Remove" data-id="${comune.id}"></button>
                `;
                selectedComuniContainer.appendChild(badge);
                
                // Add hidden input for form submission
                const hiddenInput = document.createElement('input');
                hiddenInput.type = 'hidden';
                hiddenInput.name = 'comuni';
                hiddenInput.value = comune.id;
                selectedComuniContainer.appendChild(hiddenInput);
            });
            
            // Add event listeners to remove buttons
            document.querySelectorAll('#selectedComuni .btn-close').forEach(btn => {
                btn.addEventListener('click', function() {
                    const comuneId = this.dataset.id;
                    const selectedAgentId = agentSelect.value;
                    
                    // Se è un agente esistente, rimuoviamo il comune anche dal database
                    if (selectedAgentId && selectedAgentId !== 'new') {
                        // Rimuovi dal database con chiamata asincrona
                        const formData = new FormData();
                        formData.append('agent_id', selectedAgentId);
                        formData.append('comune_id', comuneId);
                        
                        // Aggiungiamo un timestamp per evitare il caching
                        const removeTimestamp = new Date().getTime();
                        fetch('{{ url_for("remove_comune") }}?_=' + removeTimestamp, {
                            method: 'POST',
                            headers: {
                                'Cache-Control': 'no-cache, no-store, must-revalidate',
                                'Pragma': 'no-cache',
                                'Expires': '0'
                            },
                            body: formData
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                showToast('Comune rimosso con successo', 'success');
                                
                                // Rimuovi dalla UI solo dopo successo operazione DB
                                selectedComuniMap.delete(comuneId);
                                updateSelectedComuniDisplay();
                                
                                // Update selection in the select element if visible
                                if (!comuniSelect.disabled) {
                                    Array.from(comuniSelect.options).forEach(option => {
                                        if (option.value === comuneId) {
                                            option.selected = false;
                                            // Rimuovi l'attributo "già assegnato" dall'opzione
                                            option.classList.remove('assigned-comune');
                                            option.textContent = option.textContent.replace(' (Già assegnato)', '');
                                        }
                                    });
                                }
                            } else {
                                showToast('Errore durante la rimozione: ' + (data.error || 'Errore sconosciuto'), 'danger');
                            }
                        })
                        .catch(error => {
                            console.error('Errore nella rimozione del comune:', error);
                            showToast('Errore di connessione al server', 'danger');
                        });
                    } else {
                        // Comportamento normale per agenti nuovi (solo UI)
                        selectedComuniMap.delete(comuneId);
                        updateSelectedComuniDisplay();
                        
                        // Update selection in the select element if visible
                        if (!comuniSelect.disabled) {
                            Array.from(comuniSelect.options).forEach(option => {
                                if (option.value === comuneId) {
                                    option.selected = false;
                                }
                            });
                        }
                    }
                });
            });
        }
    }
    
    // Reset button handler
    resetBtn.addEventListener('click', function() {
        selectedComuniMap.clear();
        updateSelectedComuniDisplay();
        
        // Reset form fields
        regionSelect.value = '';
        provinceSelect.innerHTML = '<option value="">Seleziona prima una regione</option>';
        provinceSelect.disabled = true;
        comuniSelect.innerHTML = '<option value="">Seleziona prima una provincia</option>';
        comuniSelect.disabled = true;
        
        document.getElementById('agent_name').value = '';
    });
    
    // Initialize display
    updateSelectedComuniDisplay();
});
</script>
{% endblock %}
