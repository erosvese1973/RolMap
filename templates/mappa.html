{% extends 'layout.html' %}

{% block head %}
<title>Visualizzazione Mappa Territori</title>
<!-- Include Leaflet CSS & JS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" 
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" 
      crossorigin=""/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" 
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" 
        crossorigin=""></script>
<style>
    #map {
        height: 500px;
        width: 100%;
        border-radius: 5px;
        position: relative;
        overflow: hidden;
        border: 1px solid #ddd;
        background-color: #f5f5f5;
        z-index: 1;
    }
    .map-container {
        position: relative;
    }
    .map-overlay {
        position: absolute;
        bottom: 20px;
        left: 20px;
        background: rgba(0, 0, 0, 0.7);
        padding: 15px;
        border-radius: 5px;
        max-width: 300px;
        z-index: 400;
        color: white;
    }
    .leaflet-popup-content h6 {
        margin-top: 0;
        font-weight: bold;
    }
</style>
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <div class="d-flex justify-content-between align-items-center">
                    <h4 class="mb-0">
                        <i class="fas fa-map me-2"></i>
                        Territori Assegnati
                    </h4>
                    <a href="{{ url_for('index') }}" class="btn btn-light btn-sm">
                        <i class="fas fa-arrow-left me-1"></i>
                        Torna alla selezione
                    </a>
                </div>
            </div>
            <div class="card-body">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>Agente:</strong> {{ agent_name }}
                </div>
                
                <h5 class="mb-3">Comuni selezionati ({{ comuni|length }})</h5>
                <div class="mb-4">
                    <div class="row">
                        {% for comune in comuni %}
                        <div class="col-md-4 mb-2">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-map-marker-alt text-danger me-2"></i>
                                <span>{{ comune.name }} ({{ comune.province }}, {{ comune.region }})</span>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <h5 class="mb-3">Mappa territori</h5>
                <div class="map-container">
                    <div id="map"></div>
                    <div class="map-overlay">
                        <h6>{{ agent_name }}</h6>
                        <p class="mb-0">
                            <small>{{ comuni|length }} comuni assegnati</small>
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const comune_ids = {{ comune_ids|tojson }};
let map;

// Initialize the map when the page loads
document.addEventListener('DOMContentLoaded', function() {
    // Create the Leaflet map centered on Italy
    map = L.map('map').setView([41.9, 12.5], 6);
    
    // Add OpenStreetMap tiles
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);
    
    // Add a marker for each comune in the list
    const markers = [];
    {% for comune in comuni %}
        // Create marker for comune
        const marker = L.marker([
            // These are dummy coordinates since we don't have real ones
            // In a real app, you would store lat/lng in your DB
            41.9 + (Math.random() * 0.5 - 0.25), 
            12.5 + (Math.random() * 0.5 - 0.25)
        ]).addTo(map);
        
        // Add popup with comune info
        marker.bindPopup(`
            <div>
                <h6>{{ comune.name }}</h6>
                <p>Provincia: {{ comune.province }}</p>
                <p>Regione: {{ comune.region }}</p>
                <p>Agente: {{ agent_name }}</p>
            </div>
        `);
        
        markers.push(marker);
    {% endfor %}
    
    // If we have markers, create a group and fit the map to its bounds
    if (markers.length > 0) {
        const group = L.featureGroup(markers);
        map.fitBounds(group.getBounds(), {padding: [50, 50]});
    }
    
    // Create a polygon representing a territory
    // This is a sample polygon centered around Rome
    const polygon = L.polygon([
        [41.8, 12.4],
        [41.8, 12.6],
        [42.0, 12.6],
        [42.0, 12.4]
    ], {
        color: '#FF5722',
        fillColor: '#FF9800',
        fillOpacity: 0.5,
        weight: 2
    }).addTo(map);
    
    polygon.bindPopup("<b>Area di esempio</b><br>Territorio dell'agente");
    
    // Fetch additional GeoJSON data from the server
    fetchGeoJSON();
});

function fetchGeoJSON() {
    console.log("Fetching GeoJSON data for comuni:", comune_ids);
    
    // Fetch GeoJSON data from the server
    fetch('{{ url_for("get_geojson") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ comune_ids: comune_ids })
    })
    .then(response => response.json())
    .then(geojson => {
        console.log("Server response:", geojson);
        
        // Add the GeoJSON data to the map
        const geoJsonLayer = L.geoJSON(geojson, {
            style: {
                color: '#FF5722',
                fillColor: '#FF9800',
                fillOpacity: 0.5,
                weight: 2
            },
            onEachFeature: function(feature, layer) {
                // Add popup with feature info
                const props = feature.properties;
                const id = props ? props.id : 'Unknown';
                const name = props ? props.name : 'Unknown Municipality';
                
                layer.bindPopup(`
                    <div>
                        <h6>${name}</h6>
                        <p>Codice: ${id}</p>
                        <p>Agente: {{ agent_name }}</p>
                    </div>
                `);
            }
        }).addTo(map);
        
        // Fit map to GeoJSON boundaries
        if (geojson.features && geojson.features.length > 0) {
            map.fitBounds(geoJsonLayer.getBounds());
        }
    })
    .catch(error => {
        console.error('Error fetching GeoJSON:', error);
    });
}
</script>
{% endblock %}
