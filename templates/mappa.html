{% extends 'layout.html' %}

{% block head %}
<title>Visualizzazione Mappa Territori</title>
<!-- Include Leaflet CSS & JS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" 
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" 
      crossorigin=""/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" 
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" 
        crossorigin=""></script>
<style>
    #map {
        height: 500px;
        width: 100%;
        border-radius: 5px;
        position: relative;
        overflow: hidden;
        border: 1px solid #ddd;
        background-color: #f5f5f5;
        z-index: 1;
    }
    .map-container {
        position: relative;
    }
    .map-overlay {
        position: absolute;
        bottom: 20px;
        left: 20px;
        background: rgba(0, 0, 0, 0.7);
        padding: 15px;
        border-radius: 5px;
        max-width: 300px;
        z-index: 400;
        color: white;
    }
    .leaflet-popup-content h6 {
        margin-top: 0;
        font-weight: bold;
    }
</style>
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <div class="d-flex justify-content-between align-items-center">
                    <h4 class="mb-0">
                        <i class="fas fa-map me-2"></i>
                        Territori Assegnati
                    </h4>
                    <a href="{{ url_for('index') }}" class="btn btn-light btn-sm">
                        <i class="fas fa-arrow-left me-1"></i>
                        Torna alla selezione
                    </a>
                </div>
            </div>
            <div class="card-body">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>Agente:</strong> {{ agent_name }}
                </div>
                
                <h5 class="mb-3">Comuni selezionati ({{ comuni|length }})</h5>
                <div class="mb-4">
                    <div class="row">
                        {% for comune in comuni %}
                        <div class="col-md-4 mb-2">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-map-marker-alt text-danger me-2"></i>
                                <span>{{ comune.name }} ({{ comune.province }}, {{ comune.region }})</span>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <h5 class="mb-3">Mappa territori</h5>
                <div class="map-container">
                    <div id="map"></div>
                    <div class="map-overlay">
                        <h6>{{ agent_name }}</h6>
                        <p class="mb-0">
                            <small>{{ comuni|length }} comuni assegnati</small>
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const comune_ids = {{ comune_ids|tojson }};
let map;

// Initialize the map when the page loads
document.addEventListener('DOMContentLoaded', function() {
    // Impostare la vista iniziale sulla provincia di Lecco
    map = L.map('map').setView([45.85, 9.38], 10);
    
    // Add OpenStreetMap tiles
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);
    
    // Creazione del pulsante di controllo per la legenda
    const legendControl = L.control({position: 'bottomright'});
    legendControl.onAdd = function() {
        const div = L.DomUtil.create('div', 'info legend');
        div.style.backgroundColor = 'white';
        div.style.padding = '10px';
        div.style.borderRadius = '5px';
        div.style.border = '1px solid #ccc';
        div.innerHTML = `
            <h6 style="margin-top: 0;">Legenda</h6>
            <div style="display: flex; align-items: center; margin-bottom: 5px;">
                <div style="width: 20px; height: 20px; background-color: #FF9800; opacity: 0.5; border: 2px solid #FF5722;"></div>
                <span style="margin-left: 5px;">Comuni assegnati</span>
            </div>
            <div style="font-size: 0.9em; margin-top: 5px;">
                <strong>Agente:</strong> {{ agent_name }}<br>
                <strong>Comuni:</strong> ${comune_ids.length}
            </div>
        `;
        return div;
    };
    legendControl.addTo(map);
    
    // Disabilitiamo temporaneamente i marker per le singole localit√†, 
    // dato che ora visualizziamo i poligoni dei comuni.
    // Li genereremo dai dati reali che arrivano dal server.
    
    // Fetch GeoJSON data from the server per mostrare i confini reali dei comuni
    fetchGeoJSON();
});

function fetchGeoJSON() {
    console.log("Fetching GeoJSON data for comuni:", comune_ids);
    
    // Debug: Visualizziamo i dati di input
    document.getElementById('map').innerHTML += `<div style="position:absolute; top:10px; right:10px; z-index:9999; background-color:white; padding:5px;">Debug: ${comune_ids.length} comuni</div>`;
    
    // Fetch GeoJSON data from the server
    fetch('{{ url_for("get_geojson") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ comune_ids: comune_ids })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! Status: ${response.status}`);
        }
        return response.json();
    })
    .then(geojson => {
        console.log("Server response received:", geojson);
        
        // Verifica che geojson abbia le features
        if (!geojson || !geojson.features || geojson.features.length === 0) {
            console.error("GeoJSON response does not contain features:", geojson);
            document.getElementById('map').innerHTML += `
                <div style="position:absolute; top:40px; right:10px; z-index:9999; background-color:white; padding:5px; color:red;">
                    Errore: Nessun dato GeoJSON valido ricevuto
                </div>`;
            return;
        }
        
        console.log(`Received ${geojson.features.length} features in GeoJSON response`);
        
        // Add the GeoJSON data to the map
        try {
            const geoJsonLayer = L.geoJSON(geojson, {
                style: function(feature) {
                    return {
                        color: '#FF5722',
                        fillColor: '#FF9800',
                        fillOpacity: 0.7,
                        weight: 3,
                        opacity: 1
                    };
                },
                onEachFeature: function(feature, layer) {
                    // Add popup with feature info
                    if (feature && feature.properties) {
                        const props = feature.properties;
                        const id = props.id || 'Unknown';
                        const name = props.name || `Comune ${id}`;
                        
                        layer.bindPopup(`
                            <div>
                                <h6>${name}</h6>
                                <p>Codice: ${id}</p>
                                <p>Agente: {{ agent_name }}</p>
                            </div>
                        `);
                    }
                }
            });
            
            // Aggiungiamo il layer alla mappa
            geoJsonLayer.addTo(map);
            
            // Fit map to GeoJSON boundaries
            if (geojson.features && geojson.features.length > 0) {
                map.fitBounds(geoJsonLayer.getBounds(), { padding: [30, 30] });
                console.log("Map bounds adjusted to fit GeoJSON layer");
            }
        } catch (err) {
            console.error("Error rendering GeoJSON:", err);
            document.getElementById('map').innerHTML += `
                <div style="position:absolute; top:70px; right:10px; z-index:9999; background-color:white; padding:5px; color:red;">
                    Errore durante il rendering: ${err.message}
                </div>`;
        }
    })
    .catch(error => {
        console.error('Error fetching or processing GeoJSON:', error);
        document.getElementById('map').innerHTML += `
            <div style="position:absolute; top:100px; right:10px; z-index:9999; background-color:white; padding:5px; color:red;">
                Errore di connessione: ${error.message}
            </div>`;
    });
}
</script>
{% endblock %}
