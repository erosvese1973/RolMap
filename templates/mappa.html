{% extends 'layout.html' %}

{% block head %}
<title>Visualizzazione Mappa Territori</title>
<style>
    #map {
        height: 500px;
        width: 100%;
        border-radius: 5px;
    }
    .map-container {
        position: relative;
    }
    .map-overlay {
        position: absolute;
        bottom: 20px;
        left: 20px;
        background: rgba(0, 0, 0, 0.7);
        padding: 15px;
        border-radius: 5px;
        max-width: 300px;
        z-index: 10;
    }
</style>
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <div class="d-flex justify-content-between align-items-center">
                    <h4 class="mb-0">
                        <i class="fas fa-map me-2"></i>
                        Territori Assegnati
                    </h4>
                    <a href="{{ url_for('index') }}" class="btn btn-light btn-sm">
                        <i class="fas fa-arrow-left me-1"></i>
                        Torna alla selezione
                    </a>
                </div>
            </div>
            <div class="card-body">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>Agente:</strong> {{ agent_name }}
                </div>
                
                <h5 class="mb-3">Comuni selezionati ({{ comuni|length }})</h5>
                <div class="mb-4">
                    <div class="row">
                        {% for comune in comuni %}
                        <div class="col-md-4 mb-2">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-map-marker-alt text-danger me-2"></i>
                                <span>{{ comune.name }} ({{ comune.province }}, {{ comune.region }})</span>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <h5 class="mb-3">Mappa territori</h5>
                <div class="map-container">
                    <div id="map"></div>
                    <div class="map-overlay">
                        <h6 class="text-white">{{ agent_name }}</h6>
                        <p class="text-white mb-0">
                            <small>{{ comuni|length }} comuni assegnati</small>
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Google Maps JavaScript API with a placeholder for the API key -->
<script src="https://maps.googleapis.com/maps/api/js?key=YOUR_API_KEY&callback=initMap" 
        async defer></script>

<script>
const comune_ids = {{ comune_ids|tojson }};
let map;

function initMap() {
    // Initialize the map centered on Italy
    map = new google.maps.Map(document.getElementById('map'), {
        center: { lat: 41.9, lng: 12.5 }, // Center of Italy
        zoom: 6,
        mapTypeId: 'terrain',
        styles: [
            {
                "featureType": "administrative.locality",
                "elementType": "labels",
                "stylers": [{ "visibility": "on" }]
            },
            {
                "featureType": "administrative.neighborhood",
                "elementType": "labels",
                "stylers": [{ "visibility": "off" }]
            }
        ]
    });

    // Fetch GeoJSON data for the selected municipalities
    fetchGeoJSON();
}

function fetchGeoJSON() {
    // Show loading indicator
    const mapElement = document.getElementById('map');
    mapElement.innerHTML = '<div class="text-center p-5"><div class="spinner-border text-primary" role="status"></div><p class="mt-2">Caricamento dati geografici...</p></div>';
    
    // Fetch GeoJSON data from the server
    fetch('{{ url_for("get_geojson") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ comune_ids: comune_ids })
    })
    .then(response => response.json())
    .then(geojson => {
        // Clear loading indicator
        mapElement.innerHTML = '';
        
        // Add the GeoJSON data to the map
        map.data.addGeoJson(geojson);
        
        // Style the features (municipalities)
        map.data.setStyle({
            fillColor: '#FF9800',
            fillOpacity: 0.5,
            strokeColor: '#FF5722',
            strokeWeight: 2
        });
        
        // Add click listeners to show info about each municipality
        map.data.addListener('click', function(event) {
            const properties = event.feature.getProperty('properties');
            const id = properties ? properties.id : 'Unknown';
            const name = properties ? properties.name : 'Unknown Municipality';
            
            const infoWindow = new google.maps.InfoWindow({
                content: `<div>
                            <h6>${name}</h6>
                            <p>Codice: ${id}</p>
                            <p>Agente: {{ agent_name }}</p>
                          </div>`
            });
            
            infoWindow.setPosition(event.latLng);
            infoWindow.open(map);
        });
        
        // Calculate and center the map on the territories
        centerMapOnTerritories(geojson);
    })
    .catch(error => {
        console.error('Error fetching GeoJSON:', error);
        mapElement.innerHTML = '<div class="alert alert-danger">Errore nel caricamento dei dati geografici. Riprova pi√π tardi.</div>';
    });
}

function centerMapOnTerritories(geojson) {
    // If there's no GeoJSON data, center on Italy
    if (!geojson || !geojson.features || geojson.features.length === 0) {
        map.setCenter({ lat: 41.9, lng: 12.5 });
        map.setZoom(6);
        return;
    }
    
    // Create bounds object to contain all features
    const bounds = new google.maps.LatLngBounds();
    
    // Process each feature to extend the bounds
    geojson.features.forEach(feature => {
        if (feature.geometry && feature.geometry.type === 'Polygon') {
            // For polygons, add each coordinate point to the bounds
            feature.geometry.coordinates[0].forEach(coord => {
                bounds.extend(new google.maps.LatLng(coord[1], coord[0]));
            });
        }
    });
    
    // Fit the map to the bounds
    map.fitBounds(bounds);
    
    // Set a minimum zoom level if the area is too small
    google.maps.event.addListenerOnce(map, 'bounds_changed', function() {
        if (map.getZoom() > 12) {
            map.setZoom(12);
        }
    });
}
</script>
{% endblock %}
